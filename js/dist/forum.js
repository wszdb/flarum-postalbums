(()=>{var t={n:a=>{var e=a&&a.__esModule?()=>a.default:()=>a;return t.d(e,{a:e}),e},d:(a,e)=>{for(var i in e)t.o(e,i)&&!t.o(a,i)&&Object.defineProperty(a,i,{enumerable:!0,get:e[i]})},o:(t,a)=>Object.prototype.hasOwnProperty.call(t,a)};(()=>{"use strict";const a=flarum.core.compat["forum/app"];var e=t.n(a);const i=flarum.core.compat["common/extend"],s=flarum.core.compat["forum/components/IndexPage"];var l=t.n(s);const n=flarum.core.compat["common/components/LinkButton"];var r=t.n(n);const o=flarum.core.compat["common/components/Button"];var u=t.n(o);const c=flarum.core.compat["forum/components/CommentPost"];var d=t.n(c);function h(t,a){return h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,a){return t.__proto__=a,t},h(t,a)}function b(t,a){t.prototype=Object.create(a.prototype),t.prototype.constructor=t,h(t,a)}const p=flarum.core.compat["common/components/Page"];var f=t.n(p);const v=flarum.core.compat["common/components/LoadingIndicator"];var g=t.n(v);const N=flarum.core.compat["common/components/Placeholder"];var P=t.n(N);const y=flarum.core.compat["common/components/Link"];var A=t.n(y);const T=flarum.core.compat["common/components/Modal"];var w=t.n(T),B=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var i=a.prototype;return i.oninit=function(a){t.prototype.oninit.call(this,a),this.albumTitle="",this.description="",this.loading=!1},i.className=function(){return"CreateAlbumModal Modal--small"},i.title=function(){return"创建专辑"},i.content=function(){var t=this,a=e().forum.attribute("postalbums.album_title_length")||100,i=e().forum.attribute("postalbums.album_description_length")||500;return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",null,"专辑标题 *"),m("input",{className:"FormControl",type:"text",placeholder:"输入专辑标题",value:this.albumTitle,oninput:function(a){return t.albumTitle=a.target.value},maxlength:a}),m("div",{className:"helpText"},this.albumTitle.length,"/",a)),m("div",{className:"Form-group"},m("label",null,"专辑简介"),m("textarea",{className:"FormControl",placeholder:"输入专辑简介（可选）",rows:"3",value:this.description,oninput:function(a){return t.description=a.target.value},maxlength:i}),m("div",{className:"helpText"},this.description.length,"/",i)),m("div",{className:"Form-group"},m(u(),{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:!this.albumTitle.trim()},"创建"))))},i.onsubmit=function(t){var a=this;t.preventDefault(),this.albumTitle.trim()?(this.loading=!0,e().request({method:"POST",url:e().forum.attribute("apiUrl")+"/albums",body:{data:{attributes:{title:this.albumTitle.trim(),description:this.description.trim()}}}}).then(function(){a.hide(),e().alerts.show({type:"success"},"专辑创建成功"),m.route.set(e().route("albums",{tab:"mine"})),a.attrs.onsubmit&&a.attrs.onsubmit()}).catch(function(){a.loading=!1,m.redraw()})):e().alerts.show({type:"error"},"请输入专辑标题")},a}(w()),I=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var i=a.prototype;return i.oninit=function(a){t.prototype.oninit.call(this,a),this.loading=!0,this.albums=[],this.includedUsers={},this.currentTab=m.route.param("tab")||"all",this.currentPage=parseInt(m.route.param("page"))||1,this.totalPages=1,this.limit=parseInt(e().forum.attribute("postalbums.albums_per_page"))||20,this.total=0,this.searchQuery="",this.loadAlbums()},i.view=function(){var t=this,a=e().forum.attribute("postalbums.display_name")||"帖子专辑";return m("div",{className:"AlbumsPage"},m("div",{className:"AlbumsPage-header"},m("div",{className:"container"},m("div",{className:"AlbumsPage-toolbar"},m("h2",null,a,!this.loading&&m("span",{className:"AlbumsPage-count"},"（共计 ",this.total," 个）")),e().session.user&&m(u(),{className:"Button Button--primary",icon:"fas fa-plus",onclick:function(){return t.createAlbum()}},"创建专辑")),m("div",{className:"AlbumsPage-controls"},m("ul",{className:"AlbumsPage-nav"},m("li",null,m(u(),{className:"all"===this.currentTab?"active":"",onclick:function(){return t.switchTab("all")}},"专辑广场")),e().session.user&&m("[",null,m("li",null,m(u(),{className:"mine"===this.currentTab?"active":"",onclick:function(){return t.switchTab("mine")}},"我的专辑")),m("li",null,m(u(),{className:"following"===this.currentTab?"active":"",onclick:function(){return t.switchTab("following")}},"我的关注")))),m("div",{className:"AlbumsPage-search"},m("input",{type:"text",className:"FormControl",placeholder:"搜索专辑...",value:this.searchQuery,oninput:function(a){t.searchQuery=a.target.value},onkeypress:function(a){"Enter"===a.key&&t.search()}}),m(u(),{className:"Button Button--primary",icon:"fas fa-search",onclick:function(){return t.search()}},"搜索"))))),m("div",{className:"AlbumsPage-content"},m("div",{className:"container"},this.loading?m(g(),null):this.albums.length>0?m("[",null,this.renderAlbums(),this.renderPagination()):m(P(),{text:"暂无专辑"}))))},i.renderAlbums=function(){var t=this;return m("div",{className:"AlbumsList"},this.albums.map(function(a){return t.renderAlbumCard(a)}))},i.renderAlbumCard=function(t){var a,i=t.attributes||{},s=null==(a=t.relationships)||null==(a=a.user)?void 0:a.data,l="未知用户";if(s&&s.id){var n=this.includedUsers[s.id];n&&n.attributes&&(l=n.attributes.displayName||n.attributes.username||"未知用户")}return m("div",{className:"AlbumCard",key:t.id},m(A(),{href:e().route("albums.show",{id:t.id}),className:"AlbumCard-content"},m("h3",{className:"AlbumCard-title"},i.title||"未命名专辑"),i.description&&m("p",{className:"AlbumCard-description"},i.description),m("div",{className:"AlbumCard-meta"},m("div",{className:"AlbumCard-author"},m("i",{className:"fas fa-user"}),l),m("div",{className:"AlbumCard-time"},i.createdAt)),m("div",{className:"AlbumCard-stats"},m("span",null,m("i",{className:"fas fa-bookmark"}),i.itemsCount||0," 个收藏"),m("span",null,m("i",{className:"fas fa-heart"}),i.followersCount||0," 人关注"))))},i.renderPagination=function(){if(this.totalPages<=1)return null;var t=[];this.currentPage>1&&t.push(m(A(),{href:e().route("albums",{tab:this.currentTab,page:this.currentPage-1}),className:"Button"},"上一页"));for(var a=1;a<=this.totalPages;a++)1===a||a===this.totalPages||a>=this.currentPage-2&&a<=this.currentPage+2?t.push(m(A(),{href:e().route("albums",{tab:this.currentTab,page:a}),className:"Button "+(a===this.currentPage?"active":"")},a)):a!==this.currentPage-3&&a!==this.currentPage+3||t.push(m("span",{className:"Pagination-ellipsis"},"..."));return this.currentPage<this.totalPages&&t.push(m(A(),{href:e().route("albums",{tab:this.currentTab,page:this.currentPage+1}),className:"Button"},"下一页")),m("div",{className:"AlbumsPage-pagination"},m("div",{className:"Pagination"},t))},i.switchTab=function(t){this.currentTab=t,this.currentPage=1,m.route.set(e().route("albums",{tab:t})),this.loadAlbums()},i.search=function(){this.currentPage=1,this.loadAlbums()},i.loadAlbums=function(){var t=this;this.loading=!0;var a={"page[offset]":(this.currentPage-1)*this.limit,"page[limit]":this.limit,include:"user"};"mine"===this.currentTab?a["filter[mine]"]=!0:"following"===this.currentTab&&(a["filter[following]"]=!0),this.searchQuery&&(a["filter[q]"]=this.searchQuery),e().request({method:"GET",url:e().forum.attribute("apiUrl")+"/albums",params:a}).then(function(a){var e;t.albums=a.data||[],t.includedUsers={},a.included&&a.included.forEach(function(a){"users"===a.type&&(t.includedUsers[a.id]=a)}),t.total=(null==(e=a.meta)?void 0:e.total)||0,t.totalPages=Math.ceil(t.total/t.limit),t.loading=!1,m.redraw()}).catch(function(){t.albums=[],t.includedUsers={},t.loading=!1,m.redraw()})},i.createAlbum=function(){var t=this;e().modal.show(B,{onsubmit:function(){t.loading=!0,t.loadAlbums()}})},a}(f());flarum.core.compat["common/helpers/username"];const k=flarum.core.compat["common/helpers/humanTime"];var C=t.n(k),D=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var i=a.prototype;return i.oninit=function(a){var e,i;t.prototype.oninit.call(this,a);var s=this.attrs.album;this.albumTitle=(null==(e=s.attributes)?void 0:e.title)||"",this.description=(null==(i=s.attributes)?void 0:i.description)||"",this.loading=!1},i.className=function(){return"EditAlbumModal Modal--small"},i.title=function(){return"编辑专辑"},i.content=function(){var t=this,a=e().forum.attribute("postalbums.album_title_length")||100,i=e().forum.attribute("postalbums.album_description_length")||500;return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",null,"专辑标题 *"),m("input",{className:"FormControl",type:"text",value:this.albumTitle,oninput:function(a){return t.albumTitle=a.target.value},maxlength:a}),m("div",{className:"helpText"},this.albumTitle.length,"/",a)),m("div",{className:"Form-group"},m("label",null,"专辑简介"),m("textarea",{className:"FormControl",rows:"3",value:this.description,oninput:function(a){return t.description=a.target.value},maxlength:i}),m("div",{className:"helpText"},this.description.length,"/",i)),m("div",{className:"Form-group"},m(u(),{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:!this.albumTitle.trim()},"保存"))))},i.onsubmit=function(t){var a=this;if(t.preventDefault(),this.albumTitle.trim()){this.loading=!0;var i=this.attrs.album;e().request({method:"PATCH",url:e().forum.attribute("apiUrl")+"/albums/"+i.id,body:{data:{attributes:{title:this.albumTitle.trim(),description:this.description.trim()}}}}).then(function(){a.hide(),e().alerts.show({type:"success"},"专辑更新成功"),a.attrs.onsubmit&&a.attrs.onsubmit()}).catch(function(){a.loading=!1,m.redraw()})}else e().alerts.show({type:"error"},"请输入专辑标题")},a}(w()),F=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var i=a.prototype;return i.oninit=function(a){var e;t.prototype.oninit.call(this,a);var i=this.attrs.item;this.customTitle=(null==(e=i.attributes)?void 0:e.customTitle)||"",this.albumId=i.albumId,this.itemId=i.id,this.loading=!1},i.className=function(){return"EditItemTitleModal Modal--small"},i.title=function(){return"编辑收藏项标题"},i.content=function(){var t=this,a=e().forum.attribute("postalbums.item_title_length")||200;return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",null,"自定义标题"),m("input",{className:"FormControl",type:"text",placeholder:"留空则使用默认标题",value:this.customTitle,oninput:function(a){return t.customTitle=a.target.value},maxlength:a}),m("div",{className:"helpText"},this.customTitle.length,"/",a)),m("div",{className:"Form-group"},m(u(),{className:"Button Button--primary",type:"submit",loading:this.loading},"保存"))))},i.onsubmit=function(t){var a=this;t.preventDefault(),this.loading=!0,e().request({method:"PATCH",url:e().forum.attribute("apiUrl")+"/albums/"+this.albumId+"/items/"+this.itemId,body:{data:{attributes:{custom_title:this.customTitle.trim()}}}}).then(function(){a.hide(),e().alerts.show({type:"success"},"标题更新成功"),a.attrs.onsubmit&&a.attrs.onsubmit()}).catch(function(){a.loading=!1,m.redraw()})},a}(w()),_=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var i=a.prototype;return i.oninit=function(a){t.prototype.oninit.call(this,a),this.loading=!0,this.album=null,this.items=[],this.user=null,this.currentPage=parseInt(m.route.param("page"))||1,this.totalPages=1,this.limit=parseInt(e().forum.attribute("postalbums.items_per_page"))||10,this.total=0,this.loadAlbum()},i.view=function(){var t,a,i,s,l,n,r,o,u;return this.loading?m("div",{className:"AlbumDetailPage"},m("div",{className:"container"},m(g(),null))):this.album?m("div",{className:"AlbumDetailPage"},m("div",{className:"AlbumDetailPage-header"},m("div",{className:"container"},m(A(),{href:e().route("albums"),className:"Button Button--link"},m("i",{className:"fas fa-arrow-left"})," 返回"),m("div",{className:"AlbumDetailPage-info"},m("h1",null,(null==(t=this.album.attributes)?void 0:t.title)||"未命名专辑"),(null==(a=this.album.attributes)?void 0:a.description)&&m("p",{className:"AlbumDetailPage-description"},this.album.attributes.description),m("div",{className:"AlbumDetailPage-meta"},m("div",{className:"AlbumDetailPage-author"},m("span",null,"创建者：",this.user?m(A(),{href:e().route("user",{username:null==(i=this.user.attributes)?void 0:i.username}),className:"AlbumDetailPage-authorLink"},(null==(s=this.user.attributes)?void 0:s.displayName)||(null==(l=this.user.attributes)?void 0:l.username)||"未知用户"):m("span",null,"未知用户"),(null==(n=this.album.attributes)?void 0:n.createdAt)&&m("span",{className:"AlbumDetailPage-time"}," · ",C()(this.album.attributes.createdAt)))),m("div",{className:"AlbumDetailPage-stats"},m("span",null,m("i",{className:"fas fa-bookmark"})," ",this.total," 个收藏"),m("span",null,m("i",{className:"fas fa-heart"})," ",(null==(r=this.album.attributes)?void 0:r.followersCount)||0," 人关注"))),m("div",{className:"AlbumDetailPage-actions"},this.followButton(),(null==(o=this.album.attributes)?void 0:o.canEdit)&&this.editButton(),(null==(u=this.album.attributes)?void 0:u.canDelete)&&this.deleteButton())))),m("div",{className:"AlbumDetailPage-content"},m("div",{className:"container"},m("h3",null,"收藏的帖子"),this.renderItems(),this.renderPagination()))):m("div",{className:"AlbumDetailPage"},m("div",{className:"container"},m(P(),{text:"专辑不存在"})))},i.renderItems=function(){var t=this;return 0===this.items.length?m(P(),{text:"暂无收藏"}):m("div",{className:"AlbumItemsList"},this.items.map(function(a){return t.renderItem(a)}))},i.renderItem=function(t){var a,i=this,s=t.attributes||{},l=s.discussionId,n=s.postNumber,r=s.displayTitle||"未命名",o=s.createdAt,c="#";l&&(c=1===n?e().route("discussion",{id:l}):e().route("discussion.near",{id:l,near:n}));var d={id:t.id,albumId:this.album.id,attributes:s};return m("div",{className:"AlbumItem",key:t.id},m("div",{className:"AlbumItem-main"},m("a",{href:c,className:"AlbumItem-title",target:"_blank",rel:"noopener noreferrer"},r),m("div",{className:"AlbumItem-meta"},n>1&&m("span",null,"第",n,"楼"),n>1&&o&&m("span",null," · "),o&&m("span",null,"加入于 ",C()(o)))),(null==(a=this.album.attributes)?void 0:a.canEdit)&&m("div",{className:"AlbumItem-actions"},m(u(),{className:"Button Button--link",icon:"fas fa-edit",onclick:function(t){t.preventDefault(),i.editItemTitle(d)}},"编辑"),m(u(),{className:"Button Button--link",icon:"fas fa-trash",onclick:function(t){t.preventDefault(),i.removeItem(d)}},"移除")))},i.renderPagination=function(){if(this.totalPages<=1)return null;var t=[],a=this.album.id;this.currentPage>1&&t.push(m(A(),{href:e().route("albums.show",{id:a,page:this.currentPage-1}),className:"Button"},"上一页"));for(var i=1;i<=this.totalPages;i++)1===i||i===this.totalPages||i>=this.currentPage-2&&i<=this.currentPage+2?t.push(m(A(),{href:e().route("albums.show",{id:a,page:i}),className:"Button "+(i===this.currentPage?"active":"")},i)):i!==this.currentPage-3&&i!==this.currentPage+3||t.push(m("span",{className:"Pagination-ellipsis"},"..."));return this.currentPage<this.totalPages&&t.push(m(A(),{href:e().route("albums.show",{id:a,page:this.currentPage+1}),className:"Button"},"下一页")),m("div",{className:"AlbumDetailPage-pagination"},m("div",{className:"Pagination"},t),m("div",{className:"Pagination-info"},"第 ",this.currentPage," / ",this.totalPages," 页，共 ",this.total," 个收藏（每页 ",this.limit," 个）"))},i.followButton=function(){var t,a=this;if(!e().session.user)return null;var i=(null==(t=this.album.attributes)?void 0:t.isFollowed)||!1;return m(u(),{className:"Button "+(i?"Button--primary":""),icon:i?"fas fa-heart":"far fa-heart",onclick:function(t){t.preventDefault(),a.toggleFollow()}},i?"已关注":"关注")},i.editButton=function(){var t=this;return m(u(),{className:"Button",icon:"fas fa-edit",onclick:function(a){a.preventDefault(),e().modal.show(D,{album:t.album,onsubmit:function(){t.loading=!0,t.loadAlbum()}})}},"编辑")},i.deleteButton=function(){var t=this;return m(u(),{className:"Button Button--danger",icon:"fas fa-trash",onclick:function(a){a.preventDefault(),t.deleteAlbum()}},"删除")},i.loadAlbum=function(){var t=this;this.loading=!0;var a=m.route.param("id"),i=(this.currentPage-1)*this.limit;e().request({method:"GET",url:e().forum.attribute("apiUrl")+"/albums/"+a,params:{include:"user,items,items.post,items.post.discussion","page[offset]":i,"page[limit]":this.limit}}).then(function(a){var e,i,s;t.album=a.data;var l=a.included||[],n=null==(e=t.album.relationships)||null==(e=e.user)?void 0:e.data;n&&(t.user=l.find(function(t){return"users"===t.type&&t.id===n.id}));var r=(null==(i=t.album.relationships)||null==(i=i.items)?void 0:i.data)||[];t.items=r.map(function(t){return l.find(function(a){return"album-items"===a.type&&a.id===t.id})}).filter(function(t){return void 0!==t}),t.total=(null==(s=t.album.attributes)?void 0:s.itemsCount)||0,t.totalPages=Math.ceil(t.total/t.limit),t.loading=!1,m.redraw()}).catch(function(){t.album=null,t.loading=!1,m.redraw()})},i.toggleFollow=function(){var t,a=this,i=(null==(t=this.album.attributes)?void 0:t.isFollowed)||!1,s=i?"DELETE":"POST";e().request({method:s,url:e().forum.attribute("apiUrl")+"/albums/"+this.album.id+"/follow"}).then(function(){a.album.attributes.isFollowed=!i,a.album.attributes.followersCount=(a.album.attributes.followersCount||0)+(i?-1:1),m.redraw()})},i.editItemTitle=function(t){var a=this;e().modal.show(F,{item:t,onsubmit:function(){a.loading=!0,a.loadAlbum()}})},i.removeItem=function(t){var a=this;confirm("确定要移除此收藏项吗？")&&e().request({method:"DELETE",url:e().forum.attribute("apiUrl")+"/albums/"+t.albumId+"/items/"+t.id}).then(function(){a.loading=!0,a.loadAlbum()})},i.deleteAlbum=function(){confirm("确定要删除此专辑吗？删除后无法恢复。")&&e().request({method:"DELETE",url:e().forum.attribute("apiUrl")+"/albums/"+this.album.id}).then(function(){m.route.set(e().route("albums"))})},a}(f()),x=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var i=a.prototype;return i.oninit=function(a){t.prototype.oninit.call(this,a),this.post=this.attrs.post,this.loading=!0,this.albums=[],this.selectedAlbumId=null,this.loadUserAlbums()},i.className=function(){return"AddToAlbumModal Modal--small"},i.title=function(){return"加入专辑"},i.content=function(){var t=this;return this.loading?m("div",{className:"Modal-body"},m(g(),null)):0===this.albums.length?m("div",{className:"Modal-body"},m("p",null,"您还没有创建专辑。"),m("p",null,m(A(),{href:e().route("albums",{tab:"mine"})},"去创建专辑"))):m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",null,"选择专辑："),m("select",{className:"FormControl",value:this.selectedAlbumId||"",onchange:function(a){t.selectedAlbumId=a.target.value}},m("option",{value:""},"请选择..."),this.albums.map(function(t){var a,e;return m("option",{value:t.id,key:t.id},(null==(a=t.attributes)?void 0:a.title)||"未命名专辑","(",(null==(e=t.attributes)?void 0:e.itemsCount)||0," 个收藏)")}))),m("div",{className:"Form-group"},m(u(),{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:!this.selectedAlbumId},"确定"),m(u(),{className:"Button",onclick:function(){return e().modal.close()}},"取消"))))},i.onsubmit=function(t){var a=this;if(t.preventDefault(),this.selectedAlbumId){this.loading=!0;var i=this.post.id(),s=1===this.post.number()?"discussion":"post";e().request({method:"POST",url:e().forum.attribute("apiUrl")+"/albums/"+this.selectedAlbumId+"/items",body:{data:{type:"album-items",attributes:{post_id:i,post_type:s}}}}).then(function(){e().modal.close();var t=e().alerts.show({type:"success"},"已成功加入专辑");setTimeout(function(){e().alerts.dismiss(t)},3e3)}).catch(function(t){a.loading=!1;var i="加入失败，请稍后重试";if(t.response&&t.response.errors){var s=t.response.errors;s[0]&&s[0].detail?i=s[0].detail:s[0]&&s[0].message&&(i=s[0].message)}var l=e().alerts.show({type:"error"},i);setTimeout(function(){e().alerts.dismiss(l)},5e3),m.redraw()})}else alert("请选择一个专辑")},i.loadUserAlbums=function(){var t=this;this.loading=!0,e().request({method:"GET",url:e().forum.attribute("apiUrl")+"/albums",params:{filter:{mine:!0},"page[limit]":100}}).then(function(a){t.albums=a.data||[],t.loading=!1,m.redraw()}).catch(function(){t.albums=[],t.loading=!1,m.redraw()})},a}(w());e().initializers.add("wszdb/flarum-postalbums",function(){e().routes.albums={path:"/albums",component:I},e().routes["albums.show"]={path:"/albums/:id",component:_},(0,i.extend)(l().prototype,"navItems",function(t){var a=e().forum.attribute("postalbums.display_name")||"帖子专辑";t.add("albums",m(r(),{href:e().route("albums"),icon:"fas fa-book"},a),85)}),(0,i.extend)(d().prototype,"actionItems",function(t){var a=this.attrs.post;e().session.user&&t.add("addToAlbum",m(u(),{className:"Button Button--link",icon:"fas fa-bookmark",onclick:function(){e().modal.show(x,{post:a})}},"+专辑"),-10)})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map