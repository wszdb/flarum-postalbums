(()=>{var t={n:e=>{var a=e&&e.__esModule?()=>e.default:()=>e;return t.d(a,{a}),a},d:(e,a)=>{for(var s in a)t.o(a,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:a[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.core.compat["forum/app"];var a=t.n(e);const s=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/components/IndexPage"];var n=t.n(i);const l=flarum.core.compat["common/components/LinkButton"];var o=t.n(l);const r=flarum.core.compat["common/components/Button"];var u=t.n(r);const c=flarum.core.compat["forum/components/CommentPost"];var d=t.n(c);const h=flarum.core.compat["forum/components/DiscussionPage"];var b=t.n(h);const p=flarum.core.compat["forum/components/PostStream"];var f=t.n(p);function v(t,e){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},v(t,e)}function g(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,v(t,e)}const N=flarum.core.compat["common/components/Page"];var y=t.n(N);const A=flarum.core.compat["common/components/LoadingIndicator"];var P=t.n(A);const T=flarum.core.compat["common/components/Placeholder"];var w=t.n(T);const B=flarum.core.compat["common/components/Link"];var k=t.n(B);const _=flarum.core.compat["common/components/Modal"];var I=t.n(_),C=function(t){function e(){return t.apply(this,arguments)||this}g(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.albumTitle="",this.description="",this.loading=!1},s.className=function(){return"CreateAlbumModal Modal--small"},s.title=function(){return"创建专辑"},s.content=function(){var t=this,e=a().forum.attribute("postalbums.album_title_length")||100,s=a().forum.attribute("postalbums.album_description_length")||500;return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",null,"专辑标题 *"),m("input",{className:"FormControl",type:"text",placeholder:"输入专辑标题",value:this.albumTitle,oninput:function(e){return t.albumTitle=e.target.value},maxlength:e}),m("div",{className:"helpText"},this.albumTitle.length,"/",e)),m("div",{className:"Form-group"},m("label",null,"专辑简介"),m("textarea",{className:"FormControl",placeholder:"输入专辑简介（可选）",rows:"3",value:this.description,oninput:function(e){return t.description=e.target.value},maxlength:s}),m("div",{className:"helpText"},this.description.length,"/",s)),m("div",{className:"Form-group"},m(u(),{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:!this.albumTitle.trim()},"创建"))))},s.onsubmit=function(t){var e=this;t.preventDefault(),this.albumTitle.trim()?(this.loading=!0,a().request({method:"POST",url:a().forum.attribute("apiUrl")+"/albums",body:{data:{attributes:{title:this.albumTitle.trim(),description:this.description.trim()}}}}).then(function(){e.hide(),a().alerts.show({type:"success"},"专辑创建成功"),m.route.set(a().route("albums",{tab:"mine"})),e.attrs.onsubmit&&e.attrs.onsubmit()}).catch(function(){e.loading=!1,m.redraw()})):a().alerts.show({type:"error"},"请输入专辑标题")},e}(I()),x=function(t){function e(){return t.apply(this,arguments)||this}g(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.loading=!0,this.albums=[],this.includedUsers={},this.currentTab=m.route.param("tab")||"all",this.currentPage=parseInt(m.route.param("page"))||1,this.totalPages=1,this.limit=parseInt(a().forum.attribute("postalbums.albums_per_page"))||20,this.total=0,this.searchQuery="",this.loadAlbums()},s.view=function(){var t=this,e=a().forum.attribute("postalbums.display_name")||"帖子专辑";return m("div",{className:"AlbumsPage"},m("div",{className:"AlbumsPage-header"},m("div",{className:"container"},m("div",{className:"AlbumsPage-toolbar"},m("h2",null,e,!this.loading&&m("span",{className:"AlbumsPage-count"},"（共计 ",this.total," 个）")),a().session.user&&m(u(),{className:"Button Button--primary",icon:"fas fa-plus",onclick:function(){return t.createAlbum()}},"创建专辑")),this.renderNotice(),m("div",{className:"AlbumsPage-controls"},m("ul",{className:"AlbumsPage-nav"},m("li",null,m(u(),{className:"all"===this.currentTab?"active":"",onclick:function(){return t.switchTab("all")}},"专辑广场")),a().session.user&&m("[",null,m("li",null,m(u(),{className:"mine"===this.currentTab?"active":"",onclick:function(){return t.switchTab("mine")}},"我的专辑")),m("li",null,m(u(),{className:"following"===this.currentTab?"active":"",onclick:function(){return t.switchTab("following")}},"我的关注")))),m("div",{className:"AlbumsPage-search"},m("input",{type:"text",className:"FormControl",placeholder:"搜索专辑...",value:this.searchQuery,oninput:function(e){t.searchQuery=e.target.value},onkeypress:function(e){"Enter"===e.key&&t.search()}}),m(u(),{className:"Button Button--primary",icon:"fas fa-search",onclick:function(){return t.search()}},"搜索"))))),m("div",{className:"AlbumsPage-content"},m("div",{className:"container"},this.loading?m(P(),null):this.albums.length>0?m("[",null,this.renderAlbums(),this.renderPagination()):m(w(),{text:"暂无专辑"}))))},s.renderNotice=function(){var t=a().forum.attribute("postalbums.notice_text");return t?m("div",{className:"AlbumsPage-notice"},m("div",{className:"AlbumsPage-noticeContent"},m.trust(this.sanitizeNotice(t)))):null},s.sanitizeNotice=function(t){var e=t.replace(/\n/g,"<br>");return e.replace(/<(?!\/?(a|br)\b)[^>]+>/gi,"")},s.renderAlbums=function(){var t=this;return m("div",{className:"AlbumsList"},this.albums.map(function(e){var s,i,n,l,o,r,u,c=null==(s=e.relationships)||null==(s=s.user)||null==(s=s.data)?void 0:s.id,d=c?t.includedUsers[c]:null,h=(null==d||null==(i=d.attributes)?void 0:i.displayName)||(null==d||null==(n=d.attributes)?void 0:n.username)||"未知用户";return m("div",{className:"AlbumCard",key:e.id},m("div",{className:"AlbumCard-header"},m(k(),{href:a().route("albums.show",{id:e.id})},m("h3",null,(null==(l=e.attributes)?void 0:l.title)||"未命名专辑"))),(null==(o=e.attributes)?void 0:o.description)&&m("div",{className:"AlbumCard-description"},e.attributes.description),m("div",{className:"AlbumCard-meta"},m("div",{className:"AlbumCard-author"},m("span",null,h)),m("div",{className:"AlbumCard-stats"},m("span",null,m("i",{className:"fas fa-bookmark"})," ",(null==(r=e.attributes)?void 0:r.itemsCount)||0," 个收藏"),m("span",null,m("i",{className:"fas fa-heart"})," ",(null==(u=e.attributes)?void 0:u.followersCount)||0," 人关注"))))}))},s.renderPagination=function(){var t=this;if(this.totalPages<=1)return null;for(var e=[],a=function(a){e.push(m(u(),{key:a,className:"Button "+(a===t.currentPage?"Button--primary":""),onclick:function(){return t.goToPage(a)}},a))},s=1;s<=this.totalPages;s++)a(s);return m("div",{className:"AlbumsPage-pagination"},m(u(),{className:"Button",disabled:1===this.currentPage,onclick:function(){return t.goToPage(t.currentPage-1)}},"上一页"),e,m(u(),{className:"Button",disabled:this.currentPage===this.totalPages,onclick:function(){return t.goToPage(t.currentPage+1)}},"下一页"))},s.loadAlbums=function(){var t=this;this.loading=!0;var e={"page[offset]":(this.currentPage-1)*this.limit,"page[limit]":this.limit,include:"user"};"mine"===this.currentTab?e["filter[mine]"]=!0:"following"===this.currentTab&&(e["filter[following]"]=!0),this.searchQuery&&(e["filter[q]"]=this.searchQuery),a().request({method:"GET",url:a().forum.attribute("apiUrl")+"/albums",params:e}).then(function(e){var a;t.albums=e.data||[],t.includedUsers={},e.included&&e.included.forEach(function(e){"users"===e.type&&(t.includedUsers[e.id]=e)}),t.total=(null==(a=e.meta)?void 0:a.total)||0,t.totalPages=Math.ceil(t.total/t.limit),t.loading=!1,m.redraw()}).catch(function(){t.albums=[],t.includedUsers={},t.loading=!1,m.redraw()})},s.switchTab=function(t){this.currentTab=t,this.currentPage=1,m.route.set(a().route("albums"),{tab:t}),this.loadAlbums()},s.goToPage=function(t){this.currentPage=t,m.route.set(a().route("albums"),{tab:this.currentTab,page:t}),this.loadAlbums()},s.search=function(){this.currentPage=1,this.loadAlbums()},s.createAlbum=function(){var t=this;a().modal.show(C,{onsubmit:function(){t.loadAlbums()}})},e}(y());flarum.core.compat["common/helpers/username"];const D=flarum.core.compat["common/helpers/humanTime"];var F=t.n(D),U=function(t){function e(){return t.apply(this,arguments)||this}g(e,t);var s=e.prototype;return s.oninit=function(e){var a,s;t.prototype.oninit.call(this,e);var i=this.attrs.album;this.albumTitle=(null==(a=i.attributes)?void 0:a.title)||"",this.description=(null==(s=i.attributes)?void 0:s.description)||"",this.loading=!1},s.className=function(){return"EditAlbumModal Modal--small"},s.title=function(){return"编辑专辑"},s.content=function(){var t=this,e=a().forum.attribute("postalbums.album_title_length")||100,s=a().forum.attribute("postalbums.album_description_length")||500;return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",null,"专辑标题 *"),m("input",{className:"FormControl",type:"text",value:this.albumTitle,oninput:function(e){return t.albumTitle=e.target.value},maxlength:e}),m("div",{className:"helpText"},this.albumTitle.length,"/",e)),m("div",{className:"Form-group"},m("label",null,"专辑简介"),m("textarea",{className:"FormControl",rows:"3",value:this.description,oninput:function(e){return t.description=e.target.value},maxlength:s}),m("div",{className:"helpText"},this.description.length,"/",s)),m("div",{className:"Form-group"},m(u(),{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:!this.albumTitle.trim()},"保存"))))},s.onsubmit=function(t){var e=this;if(t.preventDefault(),this.albumTitle.trim()){this.loading=!0;var s=this.attrs.album;a().request({method:"PATCH",url:a().forum.attribute("apiUrl")+"/albums/"+s.id,body:{data:{attributes:{title:this.albumTitle.trim(),description:this.description.trim()}}}}).then(function(){e.hide(),a().alerts.show({type:"success"},"专辑更新成功"),e.attrs.onsubmit&&e.attrs.onsubmit()}).catch(function(){e.loading=!1,m.redraw()})}else a().alerts.show({type:"error"},"请输入专辑标题")},e}(I()),M=function(t){function e(){return t.apply(this,arguments)||this}g(e,t);var s=e.prototype;return s.oninit=function(e){var a;t.prototype.oninit.call(this,e);var s=this.attrs.item;this.customTitle=(null==(a=s.attributes)?void 0:a.customTitle)||"",this.albumId=s.albumId,this.itemId=s.id,this.loading=!1},s.className=function(){return"EditItemTitleModal Modal--small"},s.title=function(){return"编辑收藏项标题"},s.content=function(){var t=this,e=a().forum.attribute("postalbums.item_title_length")||200;return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",null,"自定义标题"),m("input",{className:"FormControl",type:"text",placeholder:"留空则使用默认标题",value:this.customTitle,oninput:function(e){return t.customTitle=e.target.value},maxlength:e}),m("div",{className:"helpText"},this.customTitle.length,"/",e)),m("div",{className:"Form-group"},m(u(),{className:"Button Button--primary",type:"submit",loading:this.loading},"保存"))))},s.onsubmit=function(t){var e=this;t.preventDefault(),this.loading=!0,a().request({method:"PATCH",url:a().forum.attribute("apiUrl")+"/albums/"+this.albumId+"/items/"+this.itemId,body:{data:{attributes:{custom_title:this.customTitle.trim()}}}}).then(function(){e.hide(),a().alerts.show({type:"success"},"标题更新成功"),e.attrs.onsubmit&&e.attrs.onsubmit()}).catch(function(){e.loading=!1,m.redraw()})},e}(I()),E=function(t){function e(){return t.apply(this,arguments)||this}g(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.loading=!0,this.album=null,this.items=[],this.user=null,this.currentPage=parseInt(m.route.param("page"))||1,this.totalPages=1,this.limit=parseInt(a().forum.attribute("postalbums.items_per_page"))||10,this.total=0,this.loadAlbum()},s.view=function(){var t,e,s,i,n,l,o,r,u;return this.loading?m("div",{className:"AlbumDetailPage"},m("div",{className:"container"},m(P(),null))):this.album?m("div",{className:"AlbumDetailPage"},m("div",{className:"AlbumDetailPage-header"},m("div",{className:"container"},m(k(),{href:a().route("albums"),className:"Button Button--link"},m("i",{className:"fas fa-arrow-left"})," 返回"),m("div",{className:"AlbumDetailPage-info"},m("h1",null,(null==(t=this.album.attributes)?void 0:t.title)||"未命名专辑"),(null==(e=this.album.attributes)?void 0:e.description)&&m("p",{className:"AlbumDetailPage-description"},this.album.attributes.description),m("div",{className:"AlbumDetailPage-meta"},m("div",{className:"AlbumDetailPage-author"},m("span",null,"创建者：",this.user?m(k(),{href:a().route("user",{username:null==(s=this.user.attributes)?void 0:s.username}),className:"AlbumDetailPage-authorLink"},(null==(i=this.user.attributes)?void 0:i.displayName)||(null==(n=this.user.attributes)?void 0:n.username)||"未知用户"):m("span",null,"未知用户"),(null==(l=this.album.attributes)?void 0:l.createdAt)&&m("span",{className:"AlbumDetailPage-time"}," · ",F()(this.album.attributes.createdAt)))),m("div",{className:"AlbumDetailPage-stats"},m("span",null,m("i",{className:"fas fa-bookmark"})," ",this.total," 个收藏"),m("span",null,m("i",{className:"fas fa-heart"})," ",(null==(o=this.album.attributes)?void 0:o.followersCount)||0," 人关注"))),m("div",{className:"AlbumDetailPage-actions"},this.followButton(),(null==(r=this.album.attributes)?void 0:r.canEdit)&&this.editButton(),(null==(u=this.album.attributes)?void 0:u.canDelete)&&this.deleteButton())))),m("div",{className:"AlbumDetailPage-content"},m("div",{className:"container"},m("h3",null,"收藏的帖子"),this.renderItems(),this.renderPagination()))):m("div",{className:"AlbumDetailPage"},m("div",{className:"container"},m(w(),{text:"专辑不存在"})))},s.renderItems=function(){var t=this;return 0===this.items.length?m(w(),{text:"暂无收藏"}):m("div",{className:"AlbumItemsList"},this.items.map(function(e){return t.renderItem(e)}))},s.renderItem=function(t){var e,s=this,i=t.attributes||{},n=i.discussionId,l=i.postNumber,o=i.displayTitle||"未命名",r=i.createdAt,c="#";n&&(c=1===l?a().route("discussion",{id:n}):a().route("discussion.near",{id:n,near:l}));var d={id:t.id,albumId:this.album.id,attributes:i};return m("div",{className:"AlbumItem",key:t.id},m("div",{className:"AlbumItem-main"},m("a",{href:c,className:"AlbumItem-title",target:"_blank",rel:"noopener noreferrer"},o),m("div",{className:"AlbumItem-meta"},l>1&&m("span",null,"第",l,"楼"),l>1&&r&&m("span",null," · "),r&&m("span",null,"加入于 ",F()(r)))),(null==(e=this.album.attributes)?void 0:e.canEdit)&&m("div",{className:"AlbumItem-actions"},m(u(),{className:"Button Button--link",icon:"fas fa-edit",onclick:function(t){t.preventDefault(),s.editItemTitle(d)}},"编辑"),m(u(),{className:"Button Button--link",icon:"fas fa-trash",onclick:function(t){t.preventDefault(),s.removeItem(d)}},"移除")))},s.renderPagination=function(){if(this.totalPages<=1)return null;var t=[],e=this.album.id;this.currentPage>1&&t.push(m(k(),{href:a().route("albums.show",{id:e,page:this.currentPage-1}),className:"Button"},"上一页"));for(var s=1;s<=this.totalPages;s++)1===s||s===this.totalPages||s>=this.currentPage-2&&s<=this.currentPage+2?t.push(m(k(),{href:a().route("albums.show",{id:e,page:s}),className:"Button "+(s===this.currentPage?"active":"")},s)):s!==this.currentPage-3&&s!==this.currentPage+3||t.push(m("span",{className:"Pagination-ellipsis"},"..."));return this.currentPage<this.totalPages&&t.push(m(k(),{href:a().route("albums.show",{id:e,page:this.currentPage+1}),className:"Button"},"下一页")),m("div",{className:"AlbumDetailPage-pagination"},m("div",{className:"Pagination"},t),m("div",{className:"Pagination-info"},"第 ",this.currentPage," / ",this.totalPages," 页，共 ",this.total," 个收藏（每页 ",this.limit," 个）"))},s.followButton=function(){var t,e=this;if(!a().session.user)return null;var s=(null==(t=this.album.attributes)?void 0:t.isFollowed)||!1;return m(u(),{className:"Button "+(s?"Button--primary":""),icon:s?"fas fa-heart":"far fa-heart",onclick:function(t){t.preventDefault(),e.toggleFollow()}},s?"已关注":"关注")},s.editButton=function(){var t=this;return m(u(),{className:"Button",icon:"fas fa-edit",onclick:function(e){e.preventDefault(),a().modal.show(U,{album:t.album,onsubmit:function(){t.loading=!0,t.loadAlbum()}})}},"编辑")},s.deleteButton=function(){var t=this;return m(u(),{className:"Button Button--danger",icon:"fas fa-trash",onclick:function(e){e.preventDefault(),t.deleteAlbum()}},"删除")},s.loadAlbum=function(){var t=this;this.loading=!0;var e=m.route.param("id"),s=(this.currentPage-1)*this.limit;a().request({method:"GET",url:a().forum.attribute("apiUrl")+"/albums/"+e,params:{include:"user,items,items.post,items.post.discussion","page[offset]":s,"page[limit]":this.limit}}).then(function(e){var a,s,i;t.album=e.data;var n=e.included||[],l=null==(a=t.album.relationships)||null==(a=a.user)?void 0:a.data;l&&(t.user=n.find(function(t){return"users"===t.type&&t.id===l.id}));var o=(null==(s=t.album.relationships)||null==(s=s.items)?void 0:s.data)||[];t.items=o.map(function(t){return n.find(function(e){return"album-items"===e.type&&e.id===t.id})}).filter(function(t){return void 0!==t}),t.total=(null==(i=t.album.attributes)?void 0:i.itemsCount)||0,t.totalPages=Math.ceil(t.total/t.limit),t.loading=!1,m.redraw()}).catch(function(){t.album=null,t.loading=!1,m.redraw()})},s.toggleFollow=function(){var t,e=this,s=(null==(t=this.album.attributes)?void 0:t.isFollowed)||!1,i=s?"DELETE":"POST";a().request({method:i,url:a().forum.attribute("apiUrl")+"/albums/"+this.album.id+"/follow"}).then(function(){e.album.attributes.isFollowed=!s,e.album.attributes.followersCount=(e.album.attributes.followersCount||0)+(s?-1:1),m.redraw()})},s.editItemTitle=function(t){var e=this;a().modal.show(M,{item:t,onsubmit:function(){e.loading=!0,e.loadAlbum()}})},s.removeItem=function(t){var e=this;confirm("确定要移除此收藏项吗？")&&a().request({method:"DELETE",url:a().forum.attribute("apiUrl")+"/albums/"+t.albumId+"/items/"+t.id}).then(function(){e.loading=!0,e.loadAlbum()})},s.deleteAlbum=function(){confirm("确定要删除此专辑吗？删除后无法恢复。")&&a().request({method:"DELETE",url:a().forum.attribute("apiUrl")+"/albums/"+this.album.id}).then(function(){m.route.set(a().route("albums"))})},e}(y()),R=function(t){function e(){return t.apply(this,arguments)||this}g(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.post=this.attrs.post,this.loading=!0,this.albums=[],this.selectedAlbumId=null,this.loadUserAlbums()},s.className=function(){return"AddToAlbumModal Modal--small"},s.title=function(){return"加入专辑"},s.content=function(){var t=this;return this.loading?m("div",{className:"Modal-body"},m(P(),null)):0===this.albums.length?m("div",{className:"Modal-body"},m("p",null,"您还没有创建专辑。"),m("p",null,m(k(),{href:a().route("albums",{tab:"mine"})},"去创建专辑"))):m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",null,"选择专辑："),m("select",{className:"FormControl",value:this.selectedAlbumId||"",onchange:function(e){t.selectedAlbumId=e.target.value}},m("option",{value:""},"请选择..."),this.albums.map(function(t){var e,a;return m("option",{value:t.id,key:t.id},(null==(e=t.attributes)?void 0:e.title)||"未命名专辑","(",(null==(a=t.attributes)?void 0:a.itemsCount)||0," 个收藏)")}))),m("div",{className:"Form-group"},m(u(),{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:!this.selectedAlbumId},"确定"),m(u(),{className:"Button",onclick:function(){return a().modal.close()}},"取消"))))},s.onsubmit=function(t){var e=this;if(t.preventDefault(),this.selectedAlbumId){this.loading=!0;var s=this.post.id(),i=1===this.post.number()?"discussion":"post";a().request({method:"POST",url:a().forum.attribute("apiUrl")+"/albums/"+this.selectedAlbumId+"/items",body:{data:{type:"album-items",attributes:{post_id:s,post_type:i}}}}).then(function(){a().modal.close();var t=a().alerts.show({type:"success"},"已成功加入专辑");setTimeout(function(){a().alerts.dismiss(t)},3e3)}).catch(function(t){e.loading=!1;var s="加入失败，请稍后重试";if(t.response&&t.response.errors){var i=t.response.errors;i[0]&&i[0].detail?s=i[0].detail:i[0]&&i[0].message&&(s=i[0].message)}var n=a().alerts.show({type:"error"},s);setTimeout(function(){a().alerts.dismiss(n)},5e3),m.redraw()})}else alert("请选择一个专辑")},s.loadUserAlbums=function(){var t=this;this.loading=!0,a().request({method:"GET",url:a().forum.attribute("apiUrl")+"/albums",params:{filter:{mine:!0},"page[limit]":100}}).then(function(e){t.albums=e.data||[],t.loading=!1,m.redraw()}).catch(function(){t.albums=[],t.loading=!1,m.redraw()})},e}(I());const q=flarum.core.compat["common/Component"];var O=function(t){function e(){return t.apply(this,arguments)||this}g(e,t);var s=e.prototype;return s.oninit=function(e){t.prototype.oninit.call(this,e),this.loading=!0,this.albums=[],this.includedUsers={},this.loadAlbums()},s.view=function(){var t=this;return a().forum.attribute("postalbums.show_recommendations")?m("div",{className:"RecommendedAlbums"},m("div",{className:"RecommendedAlbums-header"},m("h3",{className:"RecommendedAlbums-title"},"推荐专辑"),m(k(),{href:a().route("albums"),className:"Button Button--link"},"进入广场")),this.loading?m(P(),null):m("div",{className:"RecommendedAlbums-list"},this.albums.length>0?this.albums.map(function(e){return t.renderAlbumCard(e)}):null,this.renderPlaceholders())):null},s.renderAlbumCard=function(t){var e,s,i,n,l,o,r,u=null==(e=t.relationships)||null==(e=e.user)||null==(e=e.data)?void 0:e.id,c=u?this.includedUsers[u]:null,d=(null==c||null==(s=c.attributes)?void 0:s.displayName)||(null==c||null==(i=c.attributes)?void 0:i.username)||"未知用户",h=t.id,b=(null==(n=t.attributes)?void 0:n.title)||"未命名专辑",p=null==(l=t.attributes)?void 0:l.description,f=(null==(o=t.attributes)?void 0:o.itemsCount)||0,v=(null==(r=t.attributes)?void 0:r.followersCount)||0;return m("div",{className:"RecommendedAlbums-item",key:h},m(k(),{href:a().route("albums.show",{id:h}),className:"RecommendedAlbums-link"},m("div",{className:"RecommendedAlbums-content"},m("h4",{className:"RecommendedAlbums-albumTitle"},b),p&&m("div",{className:"RecommendedAlbums-description"},this.truncateText(p,25)),m("div",{className:"RecommendedAlbums-meta"},m("span",{className:"RecommendedAlbums-author"},m("i",{className:"fas fa-user"})," ",d),m("span",{className:"RecommendedAlbums-stats"},m("i",{className:"fas fa-bookmark"})," ",f,m("i",{className:"fas fa-heart"})," ",v)))))},s.renderPlaceholders=function(){for(var t=parseInt(a().forum.attribute("postalbums.recommendations_count"))||2,e=Math.max(0,t-this.albums.length),s=[],i=0;i<e;i++)s.push(m("div",{className:"RecommendedAlbums-item RecommendedAlbums-placeholder",key:"placeholder-"+i},m("div",{className:"RecommendedAlbums-placeholderContent"},m(k(),{href:a().route("albums"),className:"Button"},m("i",{className:"fas fa-plus"})," 创建专辑"),m("p",{className:"RecommendedAlbums-hint"},"创建你的社区专辑，分享你喜欢的论坛内容！"))));return s},s.loadAlbums=function(){var t=this,e=parseInt(a().forum.attribute("postalbums.recommendations_count"))||2;a().request({method:"GET",url:a().forum.attribute("apiUrl")+"/albums",params:{"page[limit]":50,include:"user"}}).then(function(a){var s=a.data||[];t.includedUsers={},a.included&&a.included.forEach(function(e){"users"===e.type&&(t.includedUsers[e.id]=e)});var i=s.filter(function(t){var e;return((null==(e=t.attributes)?void 0:e.itemsCount)||0)>0});t.albums=t.shuffleArray(i).slice(0,e),t.loading=!1,m.redraw()}).catch(function(e){console.error("加载推荐专辑失败:",e),t.loading=!1,t.albums=[],m.redraw()})},s.shuffleArray=function(t){for(var e=[].concat(t),a=e.length-1;a>0;a--){var s=Math.floor(Math.random()*(a+1)),i=[e[s],e[a]];e[a]=i[0],e[s]=i[1]}return e},s.truncateText=function(t,e){return t?t.length<=e?t:t.substring(0,e)+"...":""},e}(t.n(q)());a().initializers.add("wszdb/flarum-postalbums",function(){a().routes.albums={path:"/albums",component:x},a().routes["albums.show"]={path:"/albums/:id",component:E},(0,s.extend)(n().prototype,"navItems",function(t){var e=a().forum.attribute("postalbums.display_name")||"帖子专辑";t.add("albums",m(o(),{href:a().route("albums"),icon:"fas fa-book"},e),85)}),(0,s.extend)(d().prototype,"actionItems",function(t){var e=this.attrs.post;a().session.user&&t.add("addToAlbum",m(u(),{className:"Button Button--link",onclick:function(){a().modal.show(R,{post:e})}},a().forum.attribute("postalbums.add_to_album_text")||"+专辑"),-10)}),(0,s.extend)(f().prototype,"view",function(t){if(a().forum.attribute("postalbums.show_recommendations")){var e,s,i=a().forum.attribute("postalbums.recommendations_position"),n="postalbums-recommendations";"first_post"===i&&(null==(e=t.children)||e.splice(1,0,m(O,{key:n}))),"last_post"===i&&(null==(s=t.children)||s.splice(t.children.length-1,0,m(O,{key:n})))}}),(0,s.extend)(b().prototype,"mainContent",function(t){a().forum.attribute("postalbums.show_recommendations")&&"reply_block"===a().forum.attribute("postalbums.recommendations_position")&&t.add("postalbums-recommendations",m(O,null))})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map